begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"cache.h"
end_include

begin_include
include|#
directive|include
file|"lockfile.h"
end_include

begin_include
include|#
directive|include
file|"apply.h"
end_include

begin_function
DECL|function|git_apply_config
specifier|static
name|void
name|git_apply_config
parameter_list|(
name|void
parameter_list|)
block|{
name|git_config_get_string_const
argument_list|(
literal|"apply.whitespace"
argument_list|,
operator|&
name|apply_default_whitespace
argument_list|)
expr_stmt|;
name|git_config_get_string_const
argument_list|(
literal|"apply.ignorewhitespace"
argument_list|,
operator|&
name|apply_default_ignorewhitespace
argument_list|)
expr_stmt|;
name|git_config
argument_list|(
name|git_default_config
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|parse_whitespace_option
name|int
name|parse_whitespace_option
parameter_list|(
name|struct
name|apply_state
modifier|*
name|state
parameter_list|,
specifier|const
name|char
modifier|*
name|option
parameter_list|)
block|{
if|if
condition|(
operator|!
name|option
condition|)
block|{
name|state
operator|->
name|ws_error_action
operator|=
name|warn_on_ws_error
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|option
argument_list|,
literal|"warn"
argument_list|)
condition|)
block|{
name|state
operator|->
name|ws_error_action
operator|=
name|warn_on_ws_error
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|option
argument_list|,
literal|"nowarn"
argument_list|)
condition|)
block|{
name|state
operator|->
name|ws_error_action
operator|=
name|nowarn_ws_error
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|option
argument_list|,
literal|"error"
argument_list|)
condition|)
block|{
name|state
operator|->
name|ws_error_action
operator|=
name|die_on_ws_error
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|option
argument_list|,
literal|"error-all"
argument_list|)
condition|)
block|{
name|state
operator|->
name|ws_error_action
operator|=
name|die_on_ws_error
expr_stmt|;
name|state
operator|->
name|squelch_whitespace_errors
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|option
argument_list|,
literal|"strip"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|option
argument_list|,
literal|"fix"
argument_list|)
condition|)
block|{
name|state
operator|->
name|ws_error_action
operator|=
name|correct_ws_error
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|error
argument_list|(
name|_
argument_list|(
literal|"unrecognized whitespace option '%s'"
argument_list|)
argument_list|,
name|option
argument_list|)
return|;
block|}
end_function

begin_function
DECL|function|parse_ignorewhitespace_option
name|int
name|parse_ignorewhitespace_option
parameter_list|(
name|struct
name|apply_state
modifier|*
name|state
parameter_list|,
specifier|const
name|char
modifier|*
name|option
parameter_list|)
block|{
if|if
condition|(
operator|!
name|option
operator|||
operator|!
name|strcmp
argument_list|(
name|option
argument_list|,
literal|"no"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|option
argument_list|,
literal|"false"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|option
argument_list|,
literal|"never"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|option
argument_list|,
literal|"none"
argument_list|)
condition|)
block|{
name|state
operator|->
name|ws_ignore_action
operator|=
name|ignore_ws_none
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|option
argument_list|,
literal|"change"
argument_list|)
condition|)
block|{
name|state
operator|->
name|ws_ignore_action
operator|=
name|ignore_ws_change
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|error
argument_list|(
name|_
argument_list|(
literal|"unrecognized whitespace ignore option '%s'"
argument_list|)
argument_list|,
name|option
argument_list|)
return|;
block|}
end_function

begin_function
DECL|function|init_apply_state
name|void
name|init_apply_state
parameter_list|(
name|struct
name|apply_state
modifier|*
name|state
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|,
name|struct
name|lock_file
modifier|*
name|lock_file
parameter_list|)
block|{
name|memset
argument_list|(
name|state
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|state
argument_list|)
argument_list|)
expr_stmt|;
name|state
operator|->
name|prefix
operator|=
name|prefix
expr_stmt|;
name|state
operator|->
name|prefix_length
operator|=
name|state
operator|->
name|prefix
condition|?
name|strlen
argument_list|(
name|state
operator|->
name|prefix
argument_list|)
else|:
literal|0
expr_stmt|;
name|state
operator|->
name|lock_file
operator|=
name|lock_file
expr_stmt|;
name|state
operator|->
name|newfd
operator|=
operator|-
literal|1
expr_stmt|;
name|state
operator|->
name|apply
operator|=
literal|1
expr_stmt|;
name|state
operator|->
name|line_termination
operator|=
literal|'\n'
expr_stmt|;
name|state
operator|->
name|p_value
operator|=
literal|1
expr_stmt|;
name|state
operator|->
name|p_context
operator|=
name|UINT_MAX
expr_stmt|;
name|state
operator|->
name|squelch_whitespace_errors
operator|=
literal|5
expr_stmt|;
name|state
operator|->
name|ws_error_action
operator|=
name|warn_on_ws_error
expr_stmt|;
name|state
operator|->
name|ws_ignore_action
operator|=
name|ignore_ws_none
expr_stmt|;
name|state
operator|->
name|linenr
operator|=
literal|1
expr_stmt|;
name|string_list_init
argument_list|(
operator|&
name|state
operator|->
name|fn_table
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|string_list_init
argument_list|(
operator|&
name|state
operator|->
name|limit_by_name
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|string_list_init
argument_list|(
operator|&
name|state
operator|->
name|symlink_changes
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|strbuf_init
argument_list|(
operator|&
name|state
operator|->
name|root
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|git_apply_config
argument_list|()
expr_stmt|;
if|if
condition|(
name|apply_default_whitespace
operator|&&
name|parse_whitespace_option
argument_list|(
name|state
argument_list|,
name|apply_default_whitespace
argument_list|)
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|apply_default_ignorewhitespace
operator|&&
name|parse_ignorewhitespace_option
argument_list|(
name|state
argument_list|,
name|apply_default_ignorewhitespace
argument_list|)
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|clear_apply_state
name|void
name|clear_apply_state
parameter_list|(
name|struct
name|apply_state
modifier|*
name|state
parameter_list|)
block|{
name|string_list_clear
argument_list|(
operator|&
name|state
operator|->
name|limit_by_name
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|string_list_clear
argument_list|(
operator|&
name|state
operator|->
name|symlink_changes
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|strbuf_release
argument_list|(
operator|&
name|state
operator|->
name|root
argument_list|)
expr_stmt|;
comment|/*&state->fn_table is cleared at the end of apply_patch() */
block|}
end_function

end_unit

